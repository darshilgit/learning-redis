name: Redis Examples CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: Build All Examples
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Verify dependencies
      run: |
        go version
        go env
    
    # Build main module
    - name: Build main module
      run: |
        echo "Building main module..."
        go mod download
        go build -v ./...
    
    # Build basic examples
    - name: Build strings example
      run: |
        echo "Building strings example..."
        cd examples/basic/strings
        go build -v .
    
    - name: Build lists example
      run: |
        echo "Building lists example..."
        cd examples/basic/lists
        go build -v .
    
    - name: Build sets example
      run: |
        echo "Building sets example..."
        cd examples/basic/sets
        go build -v .
    
    - name: Build hashes example
      run: |
        echo "Building hashes example..."
        cd examples/basic/hashes
        go build -v .
    
    - name: Build sorted sets example
      run: |
        echo "Building sorted sets example..."
        cd examples/basic/sortedsets
        go build -v .
    
    - name: Build streams example
      run: |
        echo "Building streams example..."
        go build -v ./examples/basic/streams/...
    
    - name: Build pubsub example
      run: |
        echo "Building pubsub example..."
        go build -v ./examples/pubsub/...
    
    - name: Build caching example
      run: |
        echo "Building caching example..."
        go build -v ./examples/caching/...
    
    # Build interview scenarios
    - name: Build caching scenario
      run: |
        echo "Building caching scenario..."
        cd examples/interview-scenarios/01-caching
        go build -v .
    
    - name: Build leaderboard scenario
      run: |
        echo "Building leaderboard scenario..."
        cd examples/interview-scenarios/03-leaderboard
        go build -v .
    
    - name: Build rate limiter scenario
      run: |
        echo "Building rate limiter scenario..."
        cd examples/interview-scenarios/04-rate-limiter
        go build -v .
    
    # Build mini-redis
    - name: Build mini-redis
      run: |
        echo "Building mini-redis..."
        cd mini-redis
        go mod download
        go build -v .
    
    # Verify Go modules
    - name: Verify Go modules
      run: |
        echo "Verifying Go modules..."
        go mod verify
    
    # Run tests if any exist
    - name: Run tests
      run: |
        echo "Running tests..."
        go test -v ./... || echo "No tests found or tests failed (non-blocking)"
    
    # Check formatting
    - name: Check Go formatting
      run: |
        echo "Checking Go formatting..."
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Code is not formatted. Run 'gofmt -s -w .'"
          gofmt -s -l .
          exit 1
        fi
    
    # Vet code for common issues
    - name: Vet code
      run: |
        echo "Running go vet..."
        go vet ./examples/basic/strings/...
        go vet ./examples/basic/lists/...
        go vet ./examples/basic/sets/...
        go vet ./examples/basic/hashes/...
        go vet ./examples/basic/sortedsets/...
        go vet ./examples/basic/streams/...
        go vet ./examples/pubsub/...
        go vet ./examples/caching/...
        go vet ./examples/interview-scenarios/01-caching/...
        go vet ./examples/interview-scenarios/03-leaderboard/...
        go vet ./examples/interview-scenarios/04-rate-limiter/...
        cd mini-redis && go vet ./...
    
    - name: Summary
      if: success()
      run: |
        echo "✅ All Redis examples build successfully!"
        echo ""
        echo "Built components:"
        echo "  ✓ Main module"
        echo "  ✓ Basic examples (strings, lists, sets, hashes, sorted sets, streams)"
        echo "  ✓ Pubsub and caching examples"
        echo "  ✓ Interview scenarios (caching, leaderboard, rate limiter)"
        echo "  ✓ Mini-Redis simulator"

